<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stars</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFD700" />
  <style>
    :root{
      --bg:#fff8e1;
      --card:#ffffff;
      --head:#ffeb3b;
      --border:#ffcc80;
      --text:#333;
      --hover:#ffe082;
      --shadow:0 4px 8px rgba(0,0,0,.2);
    }
    body.naughty {
      --bg:#0a0a0a;
      --card:#121212;
      --head:#2a0000;
      --border:#3a0000;
      --text:#f8d7da;
      --hover:#1a0000;
      --shadow:0 6px 14px rgba(255,0,0,.15);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      transition:background .25s ease, color .25s ease;
    }
    body.menu-open{ overflow:hidden; }

    .topbar{
      width:100%;
      max-width:720px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      padding:8px 6px;
      backdrop-filter:saturate(140%) blur(6px);
      z-index:10;
    }

    h1{
      margin:0 0 6px 0;
      font-size:1.6rem;
      color:#ff5722;
      transition:color .25s ease;
      user-select:none;
      cursor:pointer;
    }
    body.naughty h1{ color:#ff3b3b; }

    .title-right{ display:flex; align-items:center; gap:4px; }

    .switch-wrap{ display:flex; align-items:center; gap:8px; }
    .mode-label{ font-size:.95rem; user-select:none; }
    .switch{ position:relative; width:58px; height:30px; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0; background:#ffd54f; border-radius:999px;
      box-shadow:inset 0 2px 6px rgba(0,0,0,.25);
      transition:background .25s ease;
    }
    .knob{
      position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%;
      background:#fff; display:flex; align-items:center; justify-content:center;
      font-size:15px; transition:transform .25s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    input:checked + .slider{ background:#8b0000; }
    input:checked + .slider .knob{ transform:translateX(28px); }

    .table-wrap{
      width:100%; max-width:720px; background:var(--card);
      border-radius:12px; overflow:hidden; box-shadow:var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; background:var(--card); }
    thead th{
      background:var(--head); color:#333; text-align:center;
      padding:10px; font-weight:700;
    }
    tbody td{
      border-top:2px solid var(--border);
      padding:10px; font-size:16px; text-align:center;
    }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.35); }
    body.naughty tbody tr:nth-child(even){ background:#151515; }
    tbody tr:hover{ background:var(--hover); }

    th:nth-child(1), td:nth-child(1){ width:40px; }
    th:nth-child(2), td:nth-child(2){
      width:32%;
      text-align:left;
      word-break:break-word;
      white-space:normal;
    }
    th:nth-child(3), td:nth-child(3){ width:auto; text-align:left; word-break:break-word; font-size:20px; }
    th:nth-child(4), td:nth-child(4){ width:64px; }

    .badge{
      margin:6px 0 2px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:.9rem;
      background:#fff3cd; color:#795548; display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    body.naughty .badge{ background:#330000; color:#ffb3b3; }

    .empty{ padding:18px; text-align:center; opacity:.8; }

    .notice-wrap{
      width:100%; max-width:720px;
      background:var(--card);
      border-radius:10px;
      box-shadow:var(--shadow);
      margin-top:12px;
      padding:10px 14px;
    }
    .notice-wrap h2{
      margin:0 0 6px;
      font-size:1.1rem;
      color:#d32f2f;
    }
    body.naughty .notice-wrap h2{ color:#ff6666; }
    .notice-item{ margin:4px 0; font-size:.95rem; line-height:1.3; }

    .update-banner {
      display:none;
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#4caf50;
      color:#fff;
      padding:10px 18px;
      border-radius:8px;
      font-size:.95rem;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
      z-index:1000;
      animation:fadeIn .4s ease;
    }
    .update-banner.show{ display:block; }
    @keyframes fadeIn{
      from{ opacity:0; transform:translate(-50%,20px);}
      to{ opacity:1; transform:translate(-50%,0);}
    }

    .more-btn{
      border:none; background:transparent;
      font-size:22px; cursor:pointer;
      padding:8px; border-radius:10px;
    }
    .more-btn:active{ transform:scale(.96); }

    .overlay{
      position:fixed; inset:0; display:none;
      backdrop-filter:blur(6px);
      background:rgba(0,0,0,.2);
      z-index:999;
    }
    .overlay.show{ display:block; }

    .drawer{
      position:fixed;
      top:0; right:0;
      height:100vh;
      width:75vw; max-width:520px; min-width:300px;
      background:var(--card);
      box-shadow:-8px 0 20px rgba(0,0,0,.25);
      transform:translateX(100%);
      transition:transform .28s ease;
      z-index:1000;
      display:flex; flex-direction:column;
    }
    .drawer.open{ transform:translateX(0%); }

    .drawer-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:2px solid var(--border);
      background:var(--head);
    }
    .drawer-content{
      padding:10px 14px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      flex:1;
    }

    .group{ border:2px solid var(--border); border-radius:10px; margin:10px 0; background:var(--card);}
    .group-header{
      width:100%; background:rgba(0,0,0,.04);
      border:none; padding:10px 12px; font-weight:700;
      cursor:pointer; display:flex; justify-content:space-between; align-items:center;
    }
    .group-body{ display:none; padding:10px 12px; }
    .group-body.show{ display:block; }

    .mat-subject{ margin:8px 0 4px; font-weight:800; }
    .mat-list{ list-style:none; padding:0; margin:0 0 10px 0; }
    .mat-list li a{
      display:block; padding:8px 10px; margin:6px 0;
      background:rgba(0,0,0,.04); border-radius:8px; text-decoration:none; color:inherit;
      word-break:break-word;
    }
    .mat-list li a:active{ transform:scale(.98); }

    .plan-list{ list-style:decimal; padding:0 0 0 18px; margin:0;}
    .plan-list li{ padding:6px 4px; border-bottom:1px dashed var(--border);}
    .teacher-actions{ display:none; margin-top:10px; gap:8px; flex-wrap:wrap;}
    .teacher-actions.show{ display:flex; }
    .teacher-actions button{
      padding:8px 10px; border-radius:10px;
      border:2px solid var(--border); background:var(--head); font-weight:700; cursor:pointer;
    }
    .teacher-actions button:active{ transform:scale(.98); }

    footer{ margin-top:20px; font-size:0.8rem; color:#888; text-align:center; opacity:.7; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="switch-wrap">
      <label class="switch">
        <input id="modeToggle" type="checkbox" aria-label="Toggle Naughty Mode">
        <div class="slider"><div class="knob">üåü</div></div>
      </label>
      <span class="mode-label" id="modeLabel">Stars</span>
    </div>

    <div class="title-right">
      <h1 id="appTitle">Student Points</h1>
      <button class="more-btn" id="moreBtn" aria-label="Open menu">‚ãÆ</button>
    </div>
  </div>

  <div class="badge" id="modeBadge">üåü Stars Ranking</div>

  <div class="table-wrap">
    <table id="studentTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th id="pointsHeader">Stars</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody><tr><td class="empty" colspan="4">Loading‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <!-- Notices/Reasons -->
  <div class="notice-wrap" id="noticeSection">
    <h2 id="noticeTitle">Notices</h2>
    <div id="noticeList">Loading‚Ä¶</div>
  </div>

  <!-- Right Drawer + Overlay -->
  <div id="menuOverlay" class="overlay"></div>
  <aside id="sideMenu" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <strong>Menu</strong>
      <button id="closeMenuBtn" class="more-btn" aria-label="Close menu">‚úï</button>
    </div>
    <div class="drawer-content">
      <!-- Study Materials -->
      <div class="group">
        <button class="group-header" data-target="#materialsBody">
          Study Materials <span>‚ñæ</span>
        </button>
        <div id="materialsBody" class="group-body">
          <div style="opacity:.7;">Loading‚Ä¶</div>
        </div>
      </div>

      <!-- Sit Plan -->
      <div class="group">
        <button class="group-header" data-target="#sitBody">
          Sit Plan <span>‚ñæ</span>
        </button>
        <div id="sitBody" class="group-body">
          <ol id="sitList" class="plan-list"></ol>
          <div id="teacherActions" class="teacher-actions">
            <button id="shuffleBtn">Shuffle</button>
            <button id="copySitBtn">Copy Sit Plan</button>
          </div>
          <div id="sitHint" style="margin-top:8px; opacity:.7; font-size:.9rem;"></div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Update banner -->
  <div class="update-banner" id="updateBanner">‚úÖ App updated to latest version</div>

  <footer>Made by Piu</footer>

  <script>
    /* ====== SHEETS CONFIG ====== */
    const mainSheetID   = "1dpFvFkYwTw4B8laeTQ21mrN78w5P97W3wohI7Pa_2pk";
    const mainSheetName = "Sheet1";
    const pdfSheetID    = "1HFAC0O7INymniAzrQarBPK8Jfyg3lTWBzg22cxg2wVg";
    const pdfSheetName  = "Materials";

    const studentQuery  = encodeURIComponent("SELECT A,B,F,M,P");
    const studentsURL   = `https://docs.google.com/spreadsheets/d/${mainSheetID}/gviz/tq?sheet=${mainSheetName}&tq=${studentQuery}`;
    const passURL       = `https://docs.google.com/spreadsheets/d/${mainSheetID}/gviz/tq?sheet=${mainSheetName}&range=W1:W1`;
    const seatQuery     = encodeURIComponent("SELECT I");
    const seatsURL      = `https://docs.google.com/spreadsheets/d/${mainSheetID}/gviz/tq?sheet=${mainSheetName}&tq=${seatQuery}`;
    const matQuery      = encodeURIComponent("SELECT A,B,C");
    const materialsURL  = `https://docs.google.com/spreadsheets/d/${pdfSheetID}/gviz/tq?sheet=${pdfSheetName}&tq=${matQuery}`;

    /* ====== DOM ====== */
    const tbody = document.querySelector("#studentTable tbody");
    const modeToggle = document.querySelector("#modeToggle");
    const modeLabel  = document.querySelector("#modeLabel");
    const modeBadge  = document.querySelector("#modeBadge");
    const pointsHeader = document.querySelector("#pointsHeader");
    const knob = document.querySelector(".knob");
    const noticeTitle = document.getElementById("noticeTitle");
    const noticeList = document.getElementById("noticeList");
    const appTitle = document.getElementById("appTitle");

    const moreBtn = document.getElementById("moreBtn");
    const sideMenu = document.getElementById("sideMenu");
    const menuOverlay = document.getElementById("menuOverlay");
    const closeMenuBtn = document.getElementById("closeMenuBtn");

    const materialsBody = document.getElementById("materialsBody");
    const sitBody = document.getElementById("sitBody");
    const sitList = document.getElementById("sitList");
    const teacherActions = document.getElementById("teacherActions");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const copySitBtn = document.getElementById("copySitBtn");
    const sitHint = document.getElementById("sitHint");

    /* ====== STATE ====== */
    let dataRows = [];
    let currentMode = "stars";
    let teacherPassword = "";
    let seatNames = [];           // Always fetched from Google Sheets
    let shuffledPlan = null;      // Temporary, session-only
    let teacherMode = false;
    let materialsRows = [];

    /* ====== UTILS ====== */
    function parseGViz(text){
      const json = JSON.parse(text.substr(47).slice(0, -2));
      return json.table?.rows || [];
    }

    function countEmojis(str, emojiRegex){
      if (!str) return 0;
      const m = str.match(emojiRegex);
      return m ? m.length : 0;
    }

    function openMenu(){
      sideMenu.classList.add("open");
      menuOverlay.classList.add("show");
      document.body.classList.add("menu-open");
    }
    function closeMenu(){
      sideMenu.classList.remove("open");
      menuOverlay.classList.remove("show");
      document.body.classList.remove("menu-open");
    }

    function toggleGroup(btn){
      const sel = btn.getAttribute("data-target");
      const body = document.querySelector(sel);
      if (!body) return;
      body.classList.toggle("show");
    }

    /* ====== TABLE RENDER ====== */
    function renderTable(){
      tbody.innerHTML = "";
      const rows = [];

      dataRows.forEach((row) => {
        const name = row.c[0]?.v || "";
        const starsStr = row.c[1]?.v || "";
        const naughtyStr = row.c[2]?.v || "";
        if (!name.trim()) return;

        const starsTotal   = countEmojis(starsStr, /üåü/g);
        const naughtyTotal = countEmojis(naughtyStr, /‚ùå/g);

        rows.push({
          name,
          raw: currentMode === "stars" ? starsStr : naughtyStr,
          total: currentMode === "stars" ? starsTotal : naughtyTotal
        });
      });

      rows.sort((a,b) => b.total - a.total);

      rows.forEach((r, idx) => {
        let rank = idx + 1;
        if (currentMode === "stars"){
          if (idx === 0) rank = "ü•á";
          else if (idx === 1) rank = "ü•à";
          else if (idx === 2) rank = "ü•â";
        } else {
          if (idx === 0) rank = "‚ò†Ô∏è";
          else if (idx === 1) rank = "üíÄ";
          else if (idx === 2) rank = "ü¶¥";
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${r.name}</td>
          <td class="points">${r.raw || ""}</td>
          <td>${r.total}</td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0){
        tbody.innerHTML = `<tr><td class="empty" colspan="4">No data</td></tr>`;
      }
    }

    function renderNotices(){
      noticeList.innerHTML = "";
      if (currentMode === "stars"){
        noticeTitle.textContent = "Notices";
        dataRows.forEach((row) => {
          const notice = row.c[3]?.v || "";
          if (notice.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "‚Ä¢ " + notice;
            noticeList.appendChild(div);
          }
        });
      } else {
        noticeTitle.textContent = "Reasons";
        dataRows.forEach((row) => {
          const reason = row.c[4]?.v || "";
          if (reason.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "‚Ä¢ " + reason;
            noticeList.appendChild(div);
          }
        });
      }
      if (!noticeList.innerHTML.trim()){
        noticeList.textContent = "No entries";
      }
    }

    function applyModeUI(){
      if (currentMode === "stars"){
        document.body.classList.remove("naughty");
        modeLabel.textContent = "Stars";
        modeBadge.textContent = "üåü Stars Ranking";
        pointsHeader.textContent = "Stars";
        knob.textContent = "üåü";
      } else {
        document.body.classList.add("naughty");
        modeLabel.textContent = "Naughty";
        modeBadge.textContent = "‚ùå Naughty Ranking";
        pointsHeader.textContent = "Naughty";
        knob.textContent = "‚ùå";
      }
    }

    /* ====== MATERIALS RENDER ====== */
    function renderMaterials(){
      materialsBody.innerHTML = "";
      if (!materialsRows.length){
        materialsBody.innerHTML = `<div style="opacity:.7;">No materials</div>`;
        return;
      }
      const bySubject = {};
      materialsRows.forEach(r => {
        const subject = (r.c[0]?.v || "").trim();
        const chapter = (r.c[1]?.v || "").trim();
        const link    = (r.c[2]?.v || "").trim();
        if (!subject || !chapter || !link) return;
        bySubject[subject] ||= [];
        bySubject[subject].push({ chapter, link });
      });

      Object.keys(bySubject).sort().forEach(subject => {
        const h = document.createElement("div");
        h.className = "mat-subject";
        h.textContent = subject;
        materialsBody.appendChild(h);

        const ul = document.createElement("ul");
        ul.className = "mat-list";
        bySubject[subject].forEach(item => {
          const li = document.createElement("li");
          const a  = document.createElement("a");
          a.href = item.link;
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = item.chapter;
          li.appendChild(a);
          ul.appendChild(li);
        });
        materialsBody.appendChild(ul);
      });
    }

    /* ====== SIT PLAN ====== */
    function renderSitPlan() {
      sitList.innerHTML = "";
      const list = (shuffledPlan && teacherMode) ? shuffledPlan : seatNames;
      if (!list || !list.length){
        sitList.innerHTML = `<li style="list-style:none; opacity:.7;">No names</li>`;
        return;
      }
      list.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        sitList.appendChild(li);
      });
      sitHint.textContent = teacherMode
        ? "Shuffling is temporary. Reload for fresh list from Google Sheet."
        : "";
      teacherActions.classList.toggle("show", teacherMode);
    }

    function shuffleAndPublish() {
      if (!seatNames.length) return;
      const arr = seatNames.slice();
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      shuffledPlan = arr;
      renderSitPlan();
    }

    function copySitPlan() {
      const list = (shuffledPlan && teacherMode) ? shuffledPlan : seatNames;
      if (!list || !list.length) return;
      const text = list.join('\n');
      navigator.clipboard.writeText(text)
        .then(() => alert('Sit plan copied to clipboard!'))
        .catch(() => alert('Failed to copy!'));
    }

    /* ====== CACHES ====== */
    function saveCache(key, val){
      try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){}
    }
    function loadCache(key){
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }

    /* ====== FETCH ALL ====== */
    function fetchStudents(){
      return fetch(studentsURL).then(r=>r.text()).then(t=>parseGViz(t));
    }
    function fetchPassword(){
      return fetch(passURL).then(r=>r.text()).then(t=>{
        const rows = parseGViz(t);
        const v = rows?.[0]?.c?.[0]?.v || "";
        return String(v || "");
      });
    }
    function fetchSeatNames(){
      return fetch(seatsURL).then(r=>r.text()).then(t=>{
        const rows = parseGViz(t);
        return rows.map(r => (r.c?.[0]?.v || "").trim()).filter(Boolean);
      });
    }
    function fetchMaterials(){
      return fetch(materialsURL).then(r=>r.text()).then(t=>parseGViz(t));
    }

    function loadAll(){
      Promise.allSettled([
        fetchStudents(),
        fetchPassword(),
        fetchSeatNames(),
        fetchMaterials()
      ]).then(results=>{
        if (results[0].status==="fulfilled"){
          dataRows = results[0].value || [];
          saveCache("cache_students_v3", dataRows);
        }else{
          const c = loadCache("cache_students_v3");
          if (c) dataRows = c;
        }

        if (results[1].status==="fulfilled"){
          teacherPassword = results[1].value || "";
          saveCache("cache_pass_v1", teacherPassword);
        }else{
          const c = loadCache("cache_pass_v1");
          if (c) teacherPassword = c;
        }

        if (results[2].status==="fulfilled"){
          seatNames = results[2].value || [];
          shuffledPlan = null; // always reset shuffled plan on reload!
          saveCache("cache_seats_v1", seatNames);
        }else{
          const c = loadCache("cache_seats_v1");
          if (c) seatNames = c;
          shuffledPlan = null;
        }

        if (results[3].status==="fulfilled"){
          materialsRows = results[3].value || [];
          saveCache("cache_materials_v1", materialsRows);
        }else{
          const c = loadCache("cache_materials_v1");
          if (c) materialsRows = c;
        }

        renderTable();
        renderNotices();
        renderMaterials();
        renderSitPlan();
      }).catch(()=>{
        const c1 = loadCache("cache_students_v3"); if (c1) dataRows = c1;
        const c2 = loadCache("cache_pass_v1");     if (c2) teacherPassword = c2;
        const c3 = loadCache("cache_seats_v1");    if (c3) seatNames = c3;
        const c4 = loadCache("cache_materials_v1");if (c4) materialsRows = c4;
        shuffledPlan = null;
        renderTable();
        renderNotices();
        renderMaterials();
        renderSitPlan();
      });
    }

    /* ====== MODE TOGGLE ====== */
    modeToggle.addEventListener("change", () => {
      currentMode = modeToggle.checked ? "naughty" : "stars";
      applyModeUI();
      renderTable();
      renderNotices();
    });

    /* ====== SECRET TEACHER LOGIN (triple tap title) ====== */
    let tapCount = 0, tapTimer = null;
    function askTeacherPassword(){
      const entered = prompt("Enter teacher password:");
      if (entered !== null){
        if ((teacherPassword || "").trim() && entered === teacherPassword){
          teacherMode = true;
          alert("Teacher mode enabled");
          renderSitPlan();
        }else{
          alert("Wrong password");
        }
      }
    }
    appTitle.addEventListener("click", ()=>{
      tapCount++;
      clearTimeout(tapTimer);
      tapTimer = setTimeout(()=>{ tapCount = 0; }, 600);
      if (tapCount >= 3){
        tapCount = 0;
        askTeacherPassword();
      }
    });

    /* ====== MENU & GROUP EVENTS ====== */
    moreBtn.addEventListener("click", openMenu);
    closeMenuBtn.addEventListener("click", closeMenu);
    menuOverlay.addEventListener("click", closeMenu);
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape") closeMenu();
    });

    document.querySelectorAll(".group-header").forEach(btn=>{
      btn.addEventListener("click", ()=>toggleGroup(btn));
    });

    shuffleBtn.addEventListener("click", ()=>{
      if (!teacherMode){
        alert("Teacher mode required");
        return;
      }
      shuffleAndPublish();
    });

    copySitBtn.addEventListener("click", ()=>{
      if (!teacherMode){
        alert("Teacher mode required");
        return;
      }
      copySitPlan();
    });

    /* ====== INITIALIZE ====== */
    applyModeUI();
    loadAll();

    /* ====== SERVICE WORKER CLIENT HOOKS ====== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(console.warn);
      });

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        const banner = document.getElementById("updateBanner");
        banner.classList.add("show");
        setTimeout(() => banner.classList.remove("show"), 4000);
      });

      navigator.serviceWorker.addEventListener("message", (event) => {
        if (event?.data?.action === "reload") {
          const banner = document.getElementById("updateBanner");
          banner.classList.add("show");
          setTimeout(()=>{ location.reload(); }, 500);
        }
      });
    }
  </script>
</body>
</html>
